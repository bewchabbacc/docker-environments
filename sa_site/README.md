Sport Archive Site Docker
=========================

This environment is for generating a Docker container for both
development and production of the main Sport Archive web
application.

In addition to the container, a Vagrant configuration is provided for
launching the machine as a development environment.

*Note: this docker image has the main source repository included as a
 Git submodule. The submodule must be initialized before the image can
 be built. The `setup.sh` script can take care of this for you, or you
 can initialize it manually.*

Credentials Setup
-----------------

In order to get the application running, there are various credentials
that must be setup, specifically:

* AWS S3
* Duo Security
* Google and Facebook OAuth
* Orchestrate.io
* Stripe
* JWplayer

To provide all the necessary credentials to Docker, you must run the
`./setup.sh` script in this directory. It will prompt for all the API
keys and save them to a `.env` file.

After running this script, it will also generate an SSH key that will
be placed inside the Docker container. It is recommended you take this
SSH key and add it to your GitHub account. This allows you to get
around GitHub's rate limits on anonymous users. However, this is not
required to get the container running, so you only need to do it if
you are experiencing problems. (The key is stored in the `.ssh` folder
inside this directory.)

Running with Vagrant
--------------------

### Install Vagrant

Go to the Vagrant site and install the .deb file:
https://www.vagrantup.com/downloads

### Install VirtualBox ###

This is a free VM engine. Download and install it at:
https://www.virtualbox.org/wiki/Linux_Downloads

### Get Started ###

If you are using vagrant, simply run the `setup.sh` file once, as
mentioned above, and then run `vagrant up`.

In order to update the Docker image with new code, run `vagrant
provision`. Note: the code will not update unless you do this.

### Accessing the Instance ###

#### Shell Access in Docker ####

The Docker image is running inside of a Vagrant VM, so there are
multiple steps you must perform to get a shell on the container:

1. Open a local shell and navigate to this directory.
2. Run `vagrant ssh`, which will SSH into the VM.
3. Run `sudo docker exec -it sportarc-sa_site /bin/bash`.

In the last command, it is telling docker to execute `/bin/bash` on
the "sportarc-sa_site" container, which is the name that Vagrant
automatically assigns.

*Note: you can substitute `/bin/bash` with any command you want.*

#### Browsing the Website ####

You can access the website by visiting:

    http://localhost:8080/sa-site-v2-dev/

This is because port 8080 on the host machine (your computer) is
forwarded to port 80 on the VM (and, in turn, port 80 on the VM is
connected to port 80 in the Docker container).

#### Accessing the Site Logs ####

The `logs/` sub-folder is synced into the Vagrant machine, which in
turn is synced into the Docker image. All logs from the Sport Archive
site will appear in this directory.

Running without Vagrant
-----------------------

First you must build the Docker image (note: this image is based on
the base image, which is in the sibling folder):

    docker build -t sportarc/sa_site .

Then just run the image like so:

    docker run -p 80:80 --env-file .env sa_site

The `-p 80:80` causes port 80 to be forwarded to the machine. You may
also optionally add `-d` to have Docker run in daemon mode.

As mentioned earlier, you need to provide API credentials to the
website somehow, and it is done using the `--env-file .env` switch as
shown above. This will load the API keys from the `.env` file that is
generated by the `setup.sh` script mentioned previously. If you have
your API keys in a different file, make sure to change the filename.
